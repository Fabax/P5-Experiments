function Voronoi(){this.vertices=null,this.edges=null,this.cells=null,this.toRecycle=null,this.beachsectionJunkyard=[],this.circleEventJunkyard=[],this.vertexJunkyard=[],this.edgeJunkyard=[],this.cellJunkyard=[]}Voronoi.prototype.reset=function(){if(this.beachline||(this.beachline=new this.RBTree),this.beachline.root)for(var e=this.beachline.getFirst(this.beachline.root);e;)this.beachsectionJunkyard.push(e),e=e.rbNext;this.beachline.root=null,this.circleEvents||(this.circleEvents=new this.RBTree),this.circleEvents.root=this.firstCircleEvent=null,this.vertices=[],this.edges=[],this.cells=[]},Voronoi.prototype.sqrt=Math.sqrt,Voronoi.prototype.abs=Math.abs,Voronoi.prototype.ε=Voronoi.ε=1e-9,Voronoi.prototype.invε=Voronoi.invε=1/Voronoi.ε,Voronoi.prototype.equalWithEpsilon=function(e,t){return this.abs(e-t)<1e-9},Voronoi.prototype.greaterThanWithEpsilon=function(e,t){return e-t>1e-9},Voronoi.prototype.greaterThanOrEqualWithEpsilon=function(e,t){return 1e-9>t-e},Voronoi.prototype.lessThanWithEpsilon=function(e,t){return t-e>1e-9},Voronoi.prototype.lessThanOrEqualWithEpsilon=function(e,t){return 1e-9>e-t},Voronoi.prototype.RBTree=function(){this.root=null},Voronoi.prototype.RBTree.prototype.rbInsertSuccessor=function(e,t){var r;if(e){if(t.rbPrevious=e,t.rbNext=e.rbNext,e.rbNext&&(e.rbNext.rbPrevious=t),e.rbNext=t,e.rbRight){for(e=e.rbRight;e.rbLeft;)e=e.rbLeft;e.rbLeft=t}else e.rbRight=t;r=e}else this.root?(e=this.getFirst(this.root),t.rbPrevious=null,t.rbNext=e,e.rbPrevious=t,e.rbLeft=t,r=e):(t.rbPrevious=t.rbNext=null,this.root=t,r=null);t.rbLeft=t.rbRight=null,t.rbParent=r,t.rbRed=!0;var i,o;for(e=t;r&&r.rbRed;)i=r.rbParent,r===i.rbLeft?(o=i.rbRight,o&&o.rbRed?(r.rbRed=o.rbRed=!1,i.rbRed=!0,e=i):(e===r.rbRight&&(this.rbRotateLeft(r),e=r,r=e.rbParent),r.rbRed=!1,i.rbRed=!0,this.rbRotateRight(i))):(o=i.rbLeft,o&&o.rbRed?(r.rbRed=o.rbRed=!1,i.rbRed=!0,e=i):(e===r.rbLeft&&(this.rbRotateRight(r),e=r,r=e.rbParent),r.rbRed=!1,i.rbRed=!0,this.rbRotateLeft(i))),r=e.rbParent;this.root.rbRed=!1},Voronoi.prototype.RBTree.prototype.rbRemoveNode=function(e){e.rbNext&&(e.rbNext.rbPrevious=e.rbPrevious),e.rbPrevious&&(e.rbPrevious.rbNext=e.rbNext),e.rbNext=e.rbPrevious=null;var t=e.rbParent,r=e.rbLeft,i=e.rbRight,o;o=r?i?this.getFirst(i):r:i,t?t.rbLeft===e?t.rbLeft=o:t.rbRight=o:this.root=o;var s;if(r&&i?(s=o.rbRed,o.rbRed=e.rbRed,o.rbLeft=r,r.rbParent=o,o!==i?(t=o.rbParent,o.rbParent=e.rbParent,e=o.rbRight,t.rbLeft=e,o.rbRight=i,i.rbParent=o):(o.rbParent=t,t=o,e=o.rbRight)):(s=e.rbRed,e=o),e&&(e.rbParent=t),!s){if(e&&e.rbRed)return void(e.rbRed=!1);var n;do{if(e===this.root)break;if(e===t.rbLeft){if(n=t.rbRight,n.rbRed&&(n.rbRed=!1,t.rbRed=!0,this.rbRotateLeft(t),n=t.rbRight),n.rbLeft&&n.rbLeft.rbRed||n.rbRight&&n.rbRight.rbRed){n.rbRight&&n.rbRight.rbRed||(n.rbLeft.rbRed=!1,n.rbRed=!0,this.rbRotateRight(n),n=t.rbRight),n.rbRed=t.rbRed,t.rbRed=n.rbRight.rbRed=!1,this.rbRotateLeft(t),e=this.root;break}}else if(n=t.rbLeft,n.rbRed&&(n.rbRed=!1,t.rbRed=!0,this.rbRotateRight(t),n=t.rbLeft),n.rbLeft&&n.rbLeft.rbRed||n.rbRight&&n.rbRight.rbRed){n.rbLeft&&n.rbLeft.rbRed||(n.rbRight.rbRed=!1,n.rbRed=!0,this.rbRotateLeft(n),n=t.rbLeft),n.rbRed=t.rbRed,t.rbRed=n.rbLeft.rbRed=!1,this.rbRotateRight(t),e=this.root;break}n.rbRed=!0,e=t,t=t.rbParent}while(!e.rbRed);e&&(e.rbRed=!1)}},Voronoi.prototype.RBTree.prototype.rbRotateLeft=function(e){var t=e,r=e.rbRight,i=t.rbParent;i?i.rbLeft===t?i.rbLeft=r:i.rbRight=r:this.root=r,r.rbParent=i,t.rbParent=r,t.rbRight=r.rbLeft,t.rbRight&&(t.rbRight.rbParent=t),r.rbLeft=t},Voronoi.prototype.RBTree.prototype.rbRotateRight=function(e){var t=e,r=e.rbLeft,i=t.rbParent;i?i.rbLeft===t?i.rbLeft=r:i.rbRight=r:this.root=r,r.rbParent=i,t.rbParent=r,t.rbLeft=r.rbRight,t.rbLeft&&(t.rbLeft.rbParent=t),r.rbRight=t},Voronoi.prototype.RBTree.prototype.getFirst=function(e){for(;e.rbLeft;)e=e.rbLeft;return e},Voronoi.prototype.RBTree.prototype.getLast=function(e){for(;e.rbRight;)e=e.rbRight;return e},Voronoi.prototype.Diagram=function(e){this.site=e},Voronoi.prototype.Cell=function(e){this.site=e,this.halfedges=[],this.closeMe=!1},Voronoi.prototype.Cell.prototype.init=function(e){return this.site=e,this.halfedges=[],this.closeMe=!1,this},Voronoi.prototype.createCell=function(e){var t=this.cellJunkyard.pop();return t?t.init(e):new this.Cell(e)},Voronoi.prototype.Cell.prototype.prepareHalfedges=function(){for(var e=this.halfedges,t=e.length,r;t--;)r=e[t].edge,r.vb&&r.va||e.splice(t,1);return e.sort(function(e,t){return t.angle-e.angle}),e.length},Voronoi.prototype.Cell.prototype.getNeighborIds=function(){for(var e=[],t=this.halfedges.length,r;t--;)r=this.halfedges[t].edge,null!==r.lSite&&r.lSite.voronoiId!=this.site.voronoiId?e.push(r.lSite.voronoiId):null!==r.rSite&&r.rSite.voronoiId!=this.site.voronoiId&&e.push(r.rSite.voronoiId);return e},Voronoi.prototype.Cell.prototype.getBbox=function(){for(var e=this.halfedges,t=e.length,r=1/0,i=1/0,o=-(1/0),s=-(1/0),n,h,a;t--;)n=e[t].getStartpoint(),h=n.x,a=n.y,r>h&&(r=h),i>a&&(i=a),h>o&&(o=h),a>s&&(s=a);return{x:r,y:i,width:o-r,height:s-i}},Voronoi.prototype.Cell.prototype.pointIntersection=function(e,t){for(var r=this.halfedges,i=r.length,o,s,n,h;i--;){if(o=r[i],s=o.getStartpoint(),n=o.getEndpoint(),h=(t-s.y)*(n.x-s.x)-(e-s.x)*(n.y-s.y),!h)return 0;if(h>0)return-1}return 1},Voronoi.prototype.Vertex=function(e,t){this.x=e,this.y=t},Voronoi.prototype.Edge=function(e,t){this.lSite=e,this.rSite=t,this.va=this.vb=null},Voronoi.prototype.Halfedge=function(e,t,r){if(this.site=t,this.edge=e,r)this.angle=Math.atan2(r.y-t.y,r.x-t.x);else{var i=e.va,o=e.vb;this.angle=e.lSite===t?Math.atan2(o.x-i.x,i.y-o.y):Math.atan2(i.x-o.x,o.y-i.y)}},Voronoi.prototype.createHalfedge=function(e,t,r){return new this.Halfedge(e,t,r)},Voronoi.prototype.Halfedge.prototype.getStartpoint=function(){return this.edge.lSite===this.site?this.edge.va:this.edge.vb},Voronoi.prototype.Halfedge.prototype.getEndpoint=function(){return this.edge.lSite===this.site?this.edge.vb:this.edge.va},Voronoi.prototype.createVertex=function(e,t){var r=this.vertexJunkyard.pop();return r?(r.x=e,r.y=t):r=new this.Vertex(e,t),this.vertices.push(r),r},Voronoi.prototype.createEdge=function(e,t,r,i){var o=this.edgeJunkyard.pop();return o?(o.lSite=e,o.rSite=t,o.va=o.vb=null):o=new this.Edge(e,t),this.edges.push(o),r&&this.setEdgeStartpoint(o,e,t,r),i&&this.setEdgeEndpoint(o,e,t,i),this.cells[e.voronoiId].halfedges.push(this.createHalfedge(o,e,t)),this.cells[t.voronoiId].halfedges.push(this.createHalfedge(o,t,e)),o},Voronoi.prototype.createBorderEdge=function(e,t,r){var i=this.edgeJunkyard.pop();return i?(i.lSite=e,i.rSite=null):i=new this.Edge(e,null),i.va=t,i.vb=r,this.edges.push(i),i},Voronoi.prototype.setEdgeStartpoint=function(e,t,r,i){e.va||e.vb?e.lSite===r?e.vb=i:e.va=i:(e.va=i,e.lSite=t,e.rSite=r)},Voronoi.prototype.setEdgeEndpoint=function(e,t,r,i){this.setEdgeStartpoint(e,r,t,i)},Voronoi.prototype.Beachsection=function(){},Voronoi.prototype.createBeachsection=function(e){var t=this.beachsectionJunkyard.pop();return t||(t=new this.Beachsection),t.site=e,t},Voronoi.prototype.leftBreakPoint=function(e,t){var r=e.site,i=r.x,o=r.y,s=o-t;if(!s)return i;var n=e.rbPrevious;if(!n)return-(1/0);r=n.site;var h=r.x,a=r.y,l=a-t;if(!l)return h;var c=h-i,b=1/s-1/l,f=c/l;return b?(-f+this.sqrt(f*f-2*b*(c*c/(-2*l)-a+l/2+o-s/2)))/b+i:(i+h)/2},Voronoi.prototype.rightBreakPoint=function(e,t){var r=e.rbNext;if(r)return this.leftBreakPoint(r,t);var i=e.site;return i.y===t?i.x:1/0},Voronoi.prototype.detachBeachsection=function(e){this.detachCircleEvent(e),this.beachline.rbRemoveNode(e),this.beachsectionJunkyard.push(e)},Voronoi.prototype.removeBeachsection=function(e){var t=e.circleEvent,r=t.x,i=t.ycenter,o=this.createVertex(r,i),s=e.rbPrevious,n=e.rbNext,h=[e],a=Math.abs;this.detachBeachsection(e);for(var l=s;l.circleEvent&&a(r-l.circleEvent.x)<1e-9&&a(i-l.circleEvent.ycenter)<1e-9;)s=l.rbPrevious,h.unshift(l),this.detachBeachsection(l),l=s;h.unshift(l),this.detachCircleEvent(l);for(var c=n;c.circleEvent&&a(r-c.circleEvent.x)<1e-9&&a(i-c.circleEvent.ycenter)<1e-9;)n=c.rbNext,h.push(c),this.detachBeachsection(c),c=n;h.push(c),this.detachCircleEvent(c);var b=h.length,f;for(f=1;b>f;f++)c=h[f],l=h[f-1],this.setEdgeStartpoint(c.edge,l.site,c.site,o);l=h[0],c=h[b-1],c.edge=this.createEdge(l.site,c.site,void 0,o),this.attachCircleEvent(l),this.attachCircleEvent(c)},Voronoi.prototype.addBeachsection=function(e){for(var t=e.x,r=e.y,i,o,s,n,h=this.beachline.root;h;)if(s=this.leftBreakPoint(h,r)-t,s>1e-9)h=h.rbLeft;else{if(n=t-this.rightBreakPoint(h,r),!(n>1e-9)){s>-1e-9?(i=h.rbPrevious,o=h):n>-1e-9?(i=h,o=h.rbNext):i=o=h;break}if(!h.rbRight){i=h;break}h=h.rbRight}var a=this.createBeachsection(e);if(this.beachline.rbInsertSuccessor(i,a),i||o){if(i===o)return this.detachCircleEvent(i),o=this.createBeachsection(i.site),this.beachline.rbInsertSuccessor(a,o),a.edge=o.edge=this.createEdge(i.site,a.site),this.attachCircleEvent(i),void this.attachCircleEvent(o);if(i&&!o)return void(a.edge=this.createEdge(i.site,a.site));if(i!==o){this.detachCircleEvent(i),this.detachCircleEvent(o);var l=i.site,c=l.x,b=l.y,f=e.x-c,u=e.y-b,p=o.site,d=p.x-c,v=p.y-b,g=2*(f*v-u*d),y=f*f+u*u,R=d*d+v*v,x=this.createVertex((v*y-u*R)/g+c,(f*R-d*y)/g+b);return this.setEdgeStartpoint(o.edge,l,p,x),a.edge=this.createEdge(l,e,void 0,x),o.edge=this.createEdge(e,p,void 0,x),this.attachCircleEvent(i),void this.attachCircleEvent(o)}}},Voronoi.prototype.CircleEvent=function(){this.arc=null,this.rbLeft=null,this.rbNext=null,this.rbParent=null,this.rbPrevious=null,this.rbRed=!1,this.rbRight=null,this.site=null,this.x=this.y=this.ycenter=0},Voronoi.prototype.attachCircleEvent=function(e){var t=e.rbPrevious,r=e.rbNext;if(t&&r){var i=t.site,o=e.site,s=r.site;if(i!==s){var n=o.x,h=o.y,a=i.x-n,l=i.y-h,c=s.x-n,b=s.y-h,f=2*(a*b-l*c);if(!(f>=-2e-12)){var u=a*a+l*l,p=c*c+b*b,d=(b*u-l*p)/f,v=(a*p-c*u)/f,g=v+h,y=this.circleEventJunkyard.pop();y||(y=new this.CircleEvent),y.arc=e,y.site=o,y.x=d+n,y.y=g+this.sqrt(d*d+v*v),y.ycenter=g,e.circleEvent=y;for(var R=null,x=this.circleEvents.root;x;)if(y.y<x.y||y.y===x.y&&y.x<=x.x){if(!x.rbLeft){R=x.rbPrevious;break}x=x.rbLeft}else{if(!x.rbRight){R=x;break}x=x.rbRight}this.circleEvents.rbInsertSuccessor(R,y),R||(this.firstCircleEvent=y)}}}},Voronoi.prototype.detachCircleEvent=function(e){var t=e.circleEvent;t&&(t.rbPrevious||(this.firstCircleEvent=t.rbNext),this.circleEvents.rbRemoveNode(t),this.circleEventJunkyard.push(t),e.circleEvent=null)},Voronoi.prototype.connectEdge=function(e,t){var r=e.vb;if(r)return!0;var i=e.va,o=t.xl,s=t.xr,n=t.yt,h=t.yb,a=e.lSite,l=e.rSite,c=a.x,b=a.y,f=l.x,u=l.y,p=(c+f)/2,d=(b+u)/2,v,g;if(this.cells[a.voronoiId].closeMe=!0,this.cells[l.voronoiId].closeMe=!0,u!==b&&(v=(c-f)/(u-b),g=d-v*p),void 0===v){if(o>p||p>=s)return!1;if(c>f){if(!i||i.y<n)i=this.createVertex(p,n);else if(i.y>=h)return!1;r=this.createVertex(p,h)}else{if(!i||i.y>h)i=this.createVertex(p,h);else if(i.y<n)return!1;r=this.createVertex(p,n)}}else if(-1>v||v>1)if(c>f){if(!i||i.y<n)i=this.createVertex((n-g)/v,n);else if(i.y>=h)return!1;r=this.createVertex((h-g)/v,h)}else{if(!i||i.y>h)i=this.createVertex((h-g)/v,h);else if(i.y<n)return!1;r=this.createVertex((n-g)/v,n)}else if(u>b){if(!i||i.x<o)i=this.createVertex(o,v*o+g);else if(i.x>=s)return!1;r=this.createVertex(s,v*s+g)}else{if(!i||i.x>s)i=this.createVertex(s,v*s+g);else if(i.x<o)return!1;r=this.createVertex(o,v*o+g)}return e.va=i,e.vb=r,!0},Voronoi.prototype.clipEdge=function(e,t){var r=e.va.x,i=e.va.y,o=e.vb.x,s=e.vb.y,n=0,h=1,a=o-r,l=s-i,c=r-t.xl;if(0===a&&0>c)return!1;var b=-c/a;if(0>a){if(n>b)return!1;h>b&&(h=b)}else if(a>0){if(b>h)return!1;b>n&&(n=b)}if(c=t.xr-r,0===a&&0>c)return!1;if(b=c/a,0>a){if(b>h)return!1;b>n&&(n=b)}else if(a>0){if(n>b)return!1;h>b&&(h=b)}if(c=i-t.yt,0===l&&0>c)return!1;if(b=-c/l,0>l){if(n>b)return!1;h>b&&(h=b)}else if(l>0){if(b>h)return!1;b>n&&(n=b)}if(c=t.yb-i,0===l&&0>c)return!1;if(b=c/l,0>l){if(b>h)return!1;b>n&&(n=b)}else if(l>0){if(n>b)return!1;h>b&&(h=b)}return n>0&&(e.va=this.createVertex(r+n*a,i+n*l)),1>h&&(e.vb=this.createVertex(r+h*a,i+h*l)),(n>0||1>h)&&(this.cells[e.lSite.voronoiId].closeMe=!0,this.cells[e.rSite.voronoiId].closeMe=!0),!0},Voronoi.prototype.clipEdges=function(e){for(var t=this.edges,r=t.length,i,o=Math.abs;r--;)i=t[r],(!this.connectEdge(i,e)||!this.clipEdge(i,e)||o(i.va.x-i.vb.x)<1e-9&&o(i.va.y-i.vb.y)<1e-9)&&(i.va=i.vb=null,t.splice(r,1))},Voronoi.prototype.closeCells=function(e){for(var t=e.xl,r=e.xr,i=e.yt,o=e.yb,s=this.cells,n=s.length,h,a,l,c,b,f,u,p,d,v=Math.abs;n--;)if(h=s[n],h.prepareHalfedges()&&h.closeMe){for(l=h.halfedges,c=l.length,a=0;c>a;){if(f=l[a].getEndpoint(),p=l[(a+1)%c].getStartpoint(),v(f.x-p.x)>=1e-9||v(f.y-p.y)>=1e-9)switch(!0){case this.equalWithEpsilon(f.x,t)&&this.lessThanWithEpsilon(f.y,o):if(d=this.equalWithEpsilon(p.x,t),u=this.createVertex(t,d?p.y:o),b=this.createBorderEdge(h.site,f,u),a++,l.splice(a,0,this.createHalfedge(b,h.site,null)),c++,d)break;f=u;case this.equalWithEpsilon(f.y,o)&&this.lessThanWithEpsilon(f.x,r):if(d=this.equalWithEpsilon(p.y,o),u=this.createVertex(d?p.x:r,o),b=this.createBorderEdge(h.site,f,u),a++,l.splice(a,0,this.createHalfedge(b,h.site,null)),c++,d)break;f=u;case this.equalWithEpsilon(f.x,r)&&this.greaterThanWithEpsilon(f.y,i):if(d=this.equalWithEpsilon(p.x,r),u=this.createVertex(r,d?p.y:i),b=this.createBorderEdge(h.site,f,u),a++,l.splice(a,0,this.createHalfedge(b,h.site,null)),c++,d)break;f=u;case this.equalWithEpsilon(f.y,i)&&this.greaterThanWithEpsilon(f.x,t):if(d=this.equalWithEpsilon(p.y,i),u=this.createVertex(d?p.x:t,i),b=this.createBorderEdge(h.site,f,u),a++,l.splice(a,0,this.createHalfedge(b,h.site,null)),c++,d)break;if(f=u,d=this.equalWithEpsilon(p.x,t),u=this.createVertex(t,d?p.y:o),b=this.createBorderEdge(h.site,f,u),a++,l.splice(a,0,this.createHalfedge(b,h.site,null)),c++,d)break;if(f=u,d=this.equalWithEpsilon(p.y,o),u=this.createVertex(d?p.x:r,o),b=this.createBorderEdge(h.site,f,u),a++,l.splice(a,0,this.createHalfedge(b,h.site,null)),c++,d)break;if(f=u,d=this.equalWithEpsilon(p.x,r),u=this.createVertex(r,d?p.y:i),b=this.createBorderEdge(h.site,f,u),a++,l.splice(a,0,this.createHalfedge(b,h.site,null)),c++,d)break;default:throw"Voronoi.closeCells() > this makes no sense!"}a++}h.closeMe=!1}},Voronoi.prototype.quantizeSites=function(e){for(var t=this.ε,r=e.length,i;r--;)i=e[r],i.x=Math.floor(i.x/t)*t,i.y=Math.floor(i.y/t)*t},Voronoi.prototype.recycle=function(e){if(e){if(!(e instanceof this.Diagram))throw"Voronoi.recycleDiagram() > Need a Diagram object.";this.toRecycle=e}},Voronoi.prototype.compute=function(e,t){var r=new Date;this.reset(),this.toRecycle&&(this.vertexJunkyard=this.vertexJunkyard.concat(this.toRecycle.vertices),this.edgeJunkyard=this.edgeJunkyard.concat(this.toRecycle.edges),this.cellJunkyard=this.cellJunkyard.concat(this.toRecycle.cells),this.toRecycle=null);var i=e.slice(0);i.sort(function(e,t){var r=t.y-e.y;return r?r:t.x-e.x});for(var o=i.pop(),s=0,n,h,a=this.cells,l;;)if(l=this.firstCircleEvent,o&&(!l||o.y<l.y||o.y===l.y&&o.x<l.x))(o.x!==n||o.y!==h)&&(a[s]=this.createCell(o),o.voronoiId=s++,this.addBeachsection(o),h=o.y,n=o.x),o=i.pop();else{if(!l)break;this.removeBeachsection(l.arc)}this.clipEdges(t),this.closeCells(t);var c=new Date,b=new this.Diagram;return b.cells=this.cells,b.edges=this.edges,b.vertices=this.vertices,b.execTime=c.getTime()-r.getTime(),this.reset(),b};